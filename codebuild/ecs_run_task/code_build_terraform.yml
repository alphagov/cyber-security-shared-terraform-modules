version: 0.2

env:
  shell: bash

phases:
  build:
    commands:
      - echo '[INFO] Assuming deployer role...'
      - role_arn="arn:aws:iam::${AWS_ACCOUNT_ID}:role/${ROLE_NAME}"
      - source /usr/local/bin/sts-assume-role.sh "$role_arn" "$AWS_DEFAULT_REGION"
      - echo '[INFO] Setting variables for the ECS task'
      - NETWORK_CONFIGURATION=$(jq ".${NET_CONFIG_NAME}.value' ${OUTPUT_FILENAME}.json)
      - TASK_ARN=$(jq '.${TASK_NAME}.value' ${OUTPUT_FILENAME}.json)
      - aws ecs run-task --region $REGION --task-definition=${TASK_ARN} --cluster=${CLUSTER_NAME} --group=${GROUP_NAME} --network-configuration=${NETWORK_CONFIGURATION} --count=1 --launch-type=FARGATE
  post_build:
    commands:
      - echo "TBD"

#artifacts:
 # name: TerraformPlanArtifacts
  #files:
   # - terraform_$AWS_ACCOUNT_ID.plan
  #discard-paths: no
  #base-directory: /opt

