version: 0.2

env:
  shell: bash

phases:
  pre_build:
    commands:
      - set -e
      - |
        cat <<EOF > /opt/get_output_value.sh
        #!/bin/bash
        outputs_file=\$1;
        property=\$2;
        cat \$outputs_file | jq -r --arg prop "\$property" '.[\$prop].value'
        EOF
      - TERRAFORM_OUTPUT_VAR="CODEBUILD_SRC_DIR_${TERRAFORM_OUTPUT_ARTIFACT}"
      - TERRAFORM_OUTPUT_PATH=${!TERRAFORM_OUTPUT_VAR}
      - TF_OUTPUT=$TERRAFORM_OUTPUT_PATH/$TERRAFORM_OUTPUT_FILE

  build:
    commands:
      - set -e
      - CLUSTER=$(bash /opt/get_output_value.sh $TF_OUTPUT $ECS_CLUSTER_PROP)
      - GROUP=$(bash /opt/get_output_value.sh $TF_OUTPUT $ECS_GROUP_PROP)
      - TASK_DEFINITION=$(bash /opt/get_output_value.sh $TF_OUTPUT $TASK_DEFINITION_PROP)
      - NETWORK_CONFIG=$(bash /opt/get_output_value.sh $TF_OUTPUT $NETWORK_CONFIG_PROP)
      - >
        aws ecs run-task
        --region=$AWS_REGION
        --task-definition=$TASK_DEFINITION
        --cluster=$CLUSTER
        --group=$GROUP
        --network-configuration='$NETWORK_CONFIG'
        --count=$TASK_COUNT
        --launch-type=$LAUNCH_TYPE > /opt/task-config.json
  post_build:
    commands:
      - set -e
      - echo $AWAIT_COMPLETION
      - cat /opt/task-config.json

artifacts:
  name: task
  files:
    - task-config.json
  discard-paths: no
  base-directory: /opt
